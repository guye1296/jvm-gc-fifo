#ifndef _THREAD_H_
#define _THREAD_H_

#include <stdio.h>
#include <pthread.h>

#include <sched.h>     /* CPU_SET, CPU_ZERO, cpu_set_t, sched_setaffinity() */
#include "config.h"


inline static int _thread_pin(unsigned int cpu_id)
{
    pthread_setconcurrency(USE_CPUS);
#if USE_CPUS == 80
    static int id_to_cpu[] =  {
        0, 10, 20, 30, 40, 50, 60, 70,
        1, 11, 21, 31, 41, 51, 61, 71,
        2, 12, 22, 32, 42, 52, 62, 72,
        3, 13, 23, 33, 43, 53, 63, 73,
        4, 14, 24, 34, 44, 54, 64, 74,
        5, 15, 25, 35, 45, 55, 65, 75,
        6, 16, 26, 36, 46, 56, 66, 76,
        7, 17, 27, 37, 47, 57, 67, 77,
        8, 18, 28, 38, 48, 58, 68, 78,
        9, 19, 29, 39, 49, 59, 69, 79,
    };
#elif USE_CPUS == 176
    static int id_to_cpu[] =  {
        0,   22,  44,  66, 88,  110,  132,  154,
        1,   23,  45,  67, 89,  111,  133,  155,
        2,   24,  46,  68, 90,  112,  134,  156,
        3,   25,  47,  69, 91,  113,  135,  157,
        4,   26,  48,  70, 92,  114,  136,  158,
        5,   27,  49,  71, 93,  115,  137,  159,
        6,   28,  50,  72, 94,  116,  138,  160,
        7,   29,  51,  73, 95,  117,  139,  161,
        8,   30,  52,  74, 96,  118,  140,  162,
        9,   31,  53,  75, 97,  119,  141,  163,
        10,  32,  54,  76, 98,  120,  142,  164,
        11,  33,  55,  77, 99,  121,  143,  165,
        12,  34,  56,  78, 100, 122,  144,  166,
        13,  35,  57,  79, 101, 123,  145,  167,
        14,  36,  58,  80, 102, 124,  146,  168,
        15,  37,  59,  81, 103, 125,  147,  169,
        16,  38,  60,  82, 104, 126,  148,  170,
        17,  39,  61,  83, 105, 127,  149,  171,
        18,  40,  62,  84, 106, 128,  150,  172,
        19,  41,  63,  85, 107, 129,  151,  173,
        20,  42,  64,  86, 108, 130,  152,  174,
        21,  43,  65,  87, 109, 131,  153,  175,
    };
#endif
    cpu_id = id_to_cpu[cpu_id % USE_CPUS];

    int ret = 0;
    cpu_set_t mask;  
    unsigned int len = sizeof(mask);

    CPU_ZERO(&mask);
    CPU_SET(cpu_id, &mask);
    ret = sched_setaffinity(0, len, &mask);
    if (ret == -1)
        perror("sched_setaffinity");
    return ret;
}

#endif

